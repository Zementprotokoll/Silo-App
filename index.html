<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bohr-/Silo-Erfassung</title>
  <meta name="color-scheme" content="light">
  <style>
    :root { --pad:12px; --gap:10px; --radius:10px; --maxw:1050px; color-scheme: light; }
    * { box-sizing:border-box; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,sans-serif; background:#fff; color:#111; }
    header { position:sticky; top:0; backdrop-filter:saturate(1.2) blur(6px); background:#ffffffcc; border-bottom:1px solid #e5e7eb; z-index:1; }
    header .bar { max-width:var(--maxw); margin:auto; padding:10px var(--pad); display:flex; align-items:center; gap:12px; justify-content:space-between; }
    main { max-width:var(--maxw); margin:auto; padding:16px var(--pad) 48px; }
    h1 { font-size:18px; margin:0; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:var(--radius); padding:16px; }
    .stack { display:grid; gap:var(--gap); }
    .row { display:flex; gap:var(--gap); flex-wrap:wrap; }
    label { font-size:13px; color:#475569; display:block; margin-bottom:4px; }
    input, button, select { font:inherit; }
    input[type='text'], input[type='password'], input[type='number'], input[type='date'] {
      width:100%; padding:10px; border:1px solid #d0d7de; border-radius:8px; background:#fff; color:#111;
    }
    .grid { display:grid; grid-template-columns:repeat(12,1fr); gap:var(--gap); }
    .col-3 { grid-column:span 3; } .col-4 { grid-column:span 4; } .col-6 { grid-column:span 6; } .col-12 { grid-column:span 12; }
    @media (max-width:800px){ .col-3,.col-4,.col-6 { grid-column:span 12; } }
    button { padding:10px 14px; border:1px solid #d0d7de; background:#f8fafc; color:#111; border-radius:10px; cursor:pointer; }
    button.primary { background:#2563eb; color:#fff; border-color:#2563eb; }
    button.primary:hover, button.primary:active { background:#1e54c7; border-color:#1e54c7; }
    button.ghost { background:transparent; border-color:#d0d7de; }
    button.small { padding:6px 10px; font-size:13px; }
    .toolbar { display:flex; flex-wrap:wrap; gap:8px; }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:10px 8px; border-bottom:1px solid #e5e7eb; vertical-align:top; }
    th { font-size:12px; color:#475569; font-weight:600; position:sticky; top:52px; background:#f8fafc; }
    tbody tr:hover { background:#f8fafc; }
    .muted { color:#64748b; font-size:12px; }
    .right { text-align:right; white-space:nowrap; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js" defer></script>
</head>
<body>
  <header>
    <div class="bar">
      <h1>Bohr-/Silo-Erfassung</h1>
      <div class="row" style="gap:8px;align-items:center;">
        <div id="userBox" class="muted"></div>
        <button id="logoutBtn" class="ghost small" style="display:none;">Abmelden</button>
      </div>
    </div>
  </header>

  <main>
    <section id="loginCard" class="card stack">
      <div class="stack">
        <div class="grid">
          <div class="col-6">
            <label for="username">Benutzer</label>
            <input id="username" type="text" placeholder="Benutzername" autocomplete="username">
          </div>
          <div class="col-6">
            <label for="password">Passwort</label>
            <input id="password" type="password" placeholder="Passwort" autocomplete="current-password">
          </div>
        </div>
        <div class="row">
          <button id="loginBtn" class="primary">Anmelden</button>
        </div>
      </div>
    </section>

    <section id="appCard" class="card stack" style="display:none;">
      <div class="stack">
        <div class="grid">
          <div class="col-4">
            <label for="pile">Pfahlnummer</label>
            <input id="pile" type="text" placeholder="z.B. P-101">
          </div>
          <div class="col-4">
            <label for="date">Datum</label>
            <input id="date" type="date">
          </div>
          <div class="col-4">
            <label for="flushKg">Spülungsmenge (kg)</label>
            <input id="flushKg" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0">
          </div>
          <div class="col-4">
            <label for="groutKg">Verpressmenge (kg)</label>
            <input id="groutKg" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0">
          </div>
          <div class="col-4">
            <label for="siloFillKg">Silo-Befüllung (kg)</label>
            <input id="siloFillKg" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0 (optional)">
          </div>
        </div>
        <div class="toolbar">
          <button id="createBtn" class="primary">Eintrag erstellen</button>
          <button id="reportAllBtn">Bericht erstellen (alle)</button>
          <button id="reportNewBtn">Bericht erstellen (nur neue)</button>
          <button id="hideOldBtn" class="ghost">Alte Einträge verstecken</button>
          <button id="showAllBtn" class="ghost">Alle anzeigen</button>
        </div>
      </div>

      <div class="stack">
        <div class="muted" id="summary"></div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Pfahl</th>
                <th>Datum</th>
                <th class="right">Spülung (kg)</th>
                <th class="right">Verpress. (kg)</th>
                <th class="right">Gesamt (kg)</th>
                <th class="right">Rest-Silo (kg)</th>
                <th class="right">Silo-Befüllung (kg)</th>
                <th>Aktion</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <span id="footNote">Bereit</span>
  </footer>

  <script>
  window.addEventListener('DOMContentLoaded', function() {
    // === Supabase Setup ===
    var SUPABASE_URL = "https://ridzmranmdpigksznaye.supabase.co";
    var SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpZHptcmFubWRwaWdrc3puYXllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4ODkyMzQsImV4cCI6MjA3MDQ2NTIzNH0.F7LVQphhYCW4J_11qcqTH6z5ks2kzftIH3aB9m_ukiQ";
    if (typeof supabase === 'undefined') {
      alert('Supabase-Bibliothek konnte nicht geladen werden. Bitte neu laden.');
      return;
    }
    var sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });

    // === State & Elements ===
    var allowedUsers = ['david','michael','roman'];
    var currentUser = null;

    var loginCard = document.getElementById('loginCard');
    var appCard = document.getElementById('appCard');
    var userBox = document.getElementById('userBox');
    var footNote = document.getElementById('footNote');
    var logoutBtn = document.getElementById('logoutBtn');

    var usernameEl = document.getElementById('username');
    var passwordEl = document.getElementById('password');
    var pileEl = document.getElementById('pile');
    var dateEl = document.getElementById('date');
    var flushEl = document.getElementById('flushKg');
    var groutEl = document.getElementById('groutKg');
    var fillEl = document.getElementById('siloFillKg');
    var rowsEl = document.getElementById('rows');
    var summaryEl = document.getElementById('summary');

    // Auto-restore session so refresh stays logged in
    (function restore(){
      var savedUser = localStorage.getItem('silo_user');
      if (savedUser) {
        currentUser = savedUser;
        userBox.innerHTML = 'Angemeldet als <b>' + currentUser + '</b>';
        loginCard.style.display = 'none';
        appCard.style.display = 'block';
        logoutBtn.style.display = 'inline-block';
        loadEntries();
      }
    })();

    // Heute als Default-Datum
    (function setToday(){
      var now = new Date();
      var y = now.getFullYear(), m = String(now.getMonth()+1).padStart(2,'0'), d = String(now.getDate()).padStart(2,'0');
      dateEl.value = y + '-' + m + '-' + d;
    })();

    // Login Handler
    document.getElementById('loginBtn').addEventListener('click', function() {
      var u = (usernameEl.value || '').trim().toLowerCase();
      var p = (passwordEl.value || '').trim().toLowerCase();
      if (allowedUsers.indexOf(u) === -1 || u !== p) {
        alert('Anmeldung fehlgeschlagen.');
        return;
      }
      currentUser = u.charAt(0).toUpperCase() + u.slice(1);
      localStorage.setItem('silo_user', currentUser);
      userBox.innerHTML = 'Angemeldet als <b>' + currentUser + '</b>';
      loginCard.style.display = 'none';
      appCard.style.display = 'block';
      logoutBtn.style.display = 'inline-block';
      loadEntries();
    });

    [usernameEl, passwordEl].forEach(function(el) {
      el.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') document.getElementById('loginBtn').click();
      });
    });

    // Logout
    logoutBtn.addEventListener('click', function() {
      localStorage.removeItem('silo_user');
      currentUser = null;
      userBox.textContent = '';
      loginCard.style.display = 'block';
      appCard.style.display = 'none';
      logoutBtn.style.display = 'none';
      usernameEl.value = '';
      passwordEl.value = '';
    });

    // Create entry
    document.getElementById('createBtn').addEventListener('click', async function() {
      if (!currentUser) { alert('Bitte zuerst anmelden.'); return; }
      var pile = (pileEl.value||'').trim();
      var date = dateEl.value;
      var flush = parseFloat(flushEl.value||'0');
      var grout = parseFloat(groutEl.value||'0');
      var fill  = parseFloat(fillEl.value||'0');
      if (!pile) { alert('Pfahlnummer angeben.'); return; }
      if (!date) { alert('Datum auswählen.'); return; }
      if (flush < 0 || grout < 0 || fill < 0) { alert('Negative Werte sind nicht erlaubt.'); return; }

      var ins = await sb.from('entries').insert({
        user_name: currentUser,
        pile_number: pile,
        date: date,
        flushing_kg: flush,
        grouting_kg: grout,
        silo_fill_kg: fill,
        reported: false
      });
      if (ins.error) { alert('Fehler beim Speichern: ' + ins.error.message); return; }

      groutEl.value = ''; flushEl.value=''; fillEl.value='';
      await loadEntries(true);
    });

    document.getElementById('hideOldBtn').addEventListener('click', function(){ render(currentEntries, {hideReported:true}); });
    document.getElementById('showAllBtn').addEventListener('click', function(){ render(currentEntries, {hideReported:false}); });
    document.getElementById('reportAllBtn').addEventListener('click', function(){ makeReport('Bericht (alle Einträge)', currentEntries); });
    document.getElementById('reportNewBtn').addEventListener('click', async function() {
      var onlyNew = currentEntries.filter(function(e){ return !e.reported; });
      if (onlyNew.length === 0) { alert('Keine neuen (nicht gemeldeten) Einträge.'); return; }
      await makeReport('Bericht (nur neue Einträge)', onlyNew, true);
    });

    // Data + render
    var currentEntries = [];

    async function loadEntries(scrollTop){
      footNote.textContent = 'Lade Einträge…';
      var q = await sb.from('entries').select('*').order('created_at', { ascending: false });
      if (q.error) { alert('Fehler beim Laden: ' + q.error.message); return; }
      currentEntries = q.data || [];
      render(currentEntries, {hideReported:false});
      footNote.textContent = currentEntries.length + ' Einträge – sichtbar für alle Nutzer.';
      if (scrollTop) window.scrollTo({top:0, behavior:'smooth'});
    }

    function computeRunningRest(allEntriesAsc){
      var rest = 0;
      var map = new Map();
      for (var i=0;i<allEntriesAsc.length;i++) {
        var e = allEntriesAsc[i];
        var total = (e.flushing_kg||0) + (e.grouting_kg||0);
        rest = rest + (e.silo_fill_kg||0) - total;
        map.set(e.id, rest);
      }
      return map;
    }

    function render(entries, opts){
      opts = opts || {hideReported:false};
      var ascForCalc = entries.slice().sort(function(a,b){
        var ad = a.date || ''; var bd = b.date || '';
        if (ad !== bd) return ad < bd ? -1 : 1;
        var ac = a.created_at || ''; var bc = b.created_at || '';
        if (ac !== bc) return ac < bc ? -1 : 1;
        return (a.id < b.id) ? -1 : 1;
      });
      var restMap = computeRunningRest(ascForCalc);

      var list = entries.slice().sort(function(a,b){
        var ac = a.created_at || ''; var bc = b.created_at || '';
        return ac > bc ? -1 : (ac < bc ? 1 : 0);
      });
      if (opts.hideReported) list = list.filter(function(e){ return !e.reported; });

      var sumFlush = list.reduce(function(s,e){ return s+(e.flushing_kg||0); },0);
      var sumGrout = list.reduce(function(s,e){ return s+(e.grouting_kg||0); },0);
      var sumTotal = list.reduce(function(s,e){ return s+((e.flushing_kg||0)+(e.grouting_kg||0)); },0);

      summaryEl.textContent = 'Einträge: ' + list.length +
        ' | Spülung Σ: ' + fmt(sumFlush) + ' kg' +
        ' | Verpressung Σ: ' + fmt(sumGrout) + ' kg' +
        ' | Gesamt Σ: ' + fmt(sumTotal) + ' kg' + (opts.hideReported?' | (alte Einträge ausgeblendet)':'')
      ;

      rowsEl.innerHTML = '';
      for (var i=0;i<list.length;i++) {
        var e = list[i];
        var total = (e.flushing_kg||0) + (e.grouting_kg||0);
        var tr = document.createElement('tr');
        tr.innerHTML = '' +
          '<td>'+escapeHtml(e.pile_number||'')+'</td>' +
          '<td>'+escapeHtml(e.date||'')+(e.reported?'<div class="muted">Im Bericht</div>':'')+'</td>' +
          '<td class="right">'+fmt(e.flushing_kg)+'&nbsp;</td>' +
          '<td class="right">'+fmt(e.grouting_kg)+'&nbsp;</td>' +
          '<td class="right"><b>'+fmt(total)+'</b>&nbsp;</td>' +
          '<td class="right">'+fmt(restMap.get(e.id)||0)+'&nbsp;</td>' +
          '<td class="right">'+fmt(e.silo_fill_kg)+'&nbsp;</td>' +
          '<td><div class="row" style="gap:6px;"><button class="small" data-edit="'+e.id+'">Bearbeiten</button><button class="small" data-del="'+e.id+'">Löschen</button></div></td>';
        rowsEl.appendChild(tr);
      }

      rowsEl.querySelectorAll('button[data-edit]').forEach(function(btn){
        btn.addEventListener('click', function(){ onEdit(btn.getAttribute('data-edit')); });
      });
      rowsEl.querySelectorAll('button[data-del]').forEach(function(btn){
        btn.addEventListener('click', function(){ onDelete(btn.getAttribute('data-del')); });
      });
    }

    async function onEdit(id){
      var e = currentEntries.find(function(x){ return x.id === id; });
      if (!e) return;
      var p = prompt('Pfahlnummer:', e.pile_number || '') || e.pile_number;
      var d = prompt('Datum (YYYY-MM-DD):', e.date || '') || e.date;
      var s = prompt('Spülungsmenge (kg):', (e.flushing_kg || 0)) || e.flushing_kg;
      var v = prompt('Verpressmenge (kg):', (e.grouting_kg || 0)) || e.grouting_kg;
      var f = prompt('Silo-Befüllung (kg):', (e.silo_fill_kg || 0)) || e.silo_fill_kg;
      var rep = confirm('Soll der Eintrag als "im Bericht enthalten" markiert sein? (OK = Ja, Abbrechen = Nein)') ? true : false;

      var flush = parseFloat(s||'0'), grout=parseFloat(v||'0'), fill=parseFloat(f||'0');
      if (!p || !d || flush<0 || grout<0 || fill<0) { alert('Ungültige Eingaben.'); return; }

      var up = await sb.from('entries').update({
        pile_number: p, date: d,
        flushing_kg: flush, grouting_kg: grout,
        silo_fill_kg: fill, reported: rep
      }).eq('id', id);
      if (up.error) { alert('Fehler beim Aktualisieren: '+up.error.message); return; }
      await loadEntries();
    }

    async function onDelete(id){
      if (!confirm('Eintrag wirklich löschen?')) return;
      var del = await sb.from('entries').delete().eq('id', id);
      if (del.error) { alert('Fehler beim Löschen: ' + del.error.message); return; }
      await loadEntries();
    }

    async function makeReport(title, entries, markReported){
      markReported = !!markReported;
      var ascForCalc = entries.slice().sort(function(a,b){
        var ad = a.date||''; var bd=b.date||'';
        if (ad !== bd) return ad<bd?-1:1;
        var ac=a.created_at||''; var bc=b.created_at||'';
        if (ac !== bc) return ac<bc?-1:1;
        return (a.id<b.id)?-1:1;
      });
      var restMap = computeRunningRest(ascForCalc);

      var rowsHtml = ascForCalc.map(function(e){
        var total = (e.flushing_kg||0)+(e.grouting_kg||0);
        var rest  = restMap.get(e.id)||0;
        return '<tr>' +
            '<td>'+escapeHtml(e.pile_number||'')+'</td>' +
            '<td>'+escapeHtml(e.date||'')+'</td>' +
            '<td class="r">'+fmt(e.flushing_kg)+'</td>' +
            '<td class="r">'+fmt(e.grouting_kg)+'</td>' +
            '<td class="r">'+fmt(total)+'</td>' +
            '<td class="r">'+fmt(rest)+'</td>' +
            '<td class="r">'+fmt(e.silo_fill_kg)+'</td>' +
            '<td>'+escapeHtml(e.user_name||'')+'</td>' +
          '</tr>';
      }).join('');

      var w = window.open('', '_blank');
      w.document.write('<!doctype html><html><head>' +
        '<meta charset="utf-8"><title>'+escapeHtml(title)+'</title>' +
        '<style>@page{size:A4;margin:14mm}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}h1{font-size:18px;margin:0 0 8px 0}.muted{font-size:12px;color:#555;margin-bottom:12px}table{width:100%;border-collapse:collapse}th,td{border-bottom:1px solid #ddd;padding:6px 4px;text-align:left}th{font-size:12px;color:#333}td.r{text-align:right;white-space:nowrap}.footer{margin-top:12px;font-size:12px;color:#555}</style>' +
        '</head><body>' +
        '<h1>'+escapeHtml(title)+'</h1>' +
        '<div class="muted">Erstellt am '+new Date().toLocaleString('de-DE',{ timeZone:'Europe/Berlin' })+'</div>' +
        '<table><thead><tr><th>Pfahl</th><th>Datum</th><th class="r">Spülung (kg)</th><th class="r">Verpress. (kg)</th><th class="r">Gesamt (kg)</th><th class="r">Rest-Silo (kg)</th><th class="r">Silo-Befüllung (kg)</th><th>Erfasser</th></tr></thead><tbody>'+rowsHtml+'</tbody></table>' +
        '<div class="footer">Hinweis: PDF kann per Druckdialog gespeichert/versendet werden.</div>' +
        '<script>window.focus(); setTimeout(function(){window.print();}, 200);<\/script>' +
        '</body></html>');
      w.document.close();

      if (markReported) {
        var ids = entries.map(function(e){ return e.id; });
        if (ids.length){
          var up = await sb.from('entries').update({ reported:true }).in('id', ids);
          if (up.error) alert('Konnte "im Bericht" nicht markieren: ' + up.error.message);
          await loadEntries();
        }
      }
    }

    function fmt(x){ var v = Number(x||0); return v.toLocaleString('de-DE', {minimumFractionDigits:0, maximumFractionDigits:2}); }
    function escapeHtml(s){
      return (s==null ? '' : String(s)).replace(/[&<>"']/g, function(m){
        return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' })[m];
      });
    }
  });
  </script>
</body>
</html>
